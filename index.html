<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <title>Urban Management | Digital Twin</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    :root { --header-bg: #ffffff; --sidebar-bg: #ffffff; --text: #1e293b; --accent: #0284c7; --border: #e2e8f0; }
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; font-family: sans-serif; background: #f1f5f9; color: var(--text); overflow: hidden; }
    header { height: 60px; background: var(--header-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; border-bottom: 2px solid var(--border); z-index: 100; }
    .logo { font-weight: 800; font-size: 1.1rem; color: #000; text-transform: uppercase; }
    #main-wrapper { display: flex; height: calc(100% - 60px); width: 100%; }
    #viewDiv { flex: 1; height: 100%; background: #e5e7eb; }
    #sidebar { width: 300px; background: var(--sidebar-bg); border-left: 2px solid var(--border); padding: 25px; display: flex; flex-direction: column; gap: 25px; box-shadow: -2px 0 10px rgba(0,0,0,0.05); }
    h3 { font-size: 0.8rem; text-transform: uppercase; color: #64748b; margin: 0; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
    .btn-main { width: 100%; padding: 12px; background: #0f172a; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .search-box { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; }
  </style>
</head>
<body>
<header>
  <div class="logo">Urban Management</div>
  <div style="text-align: right;">
    <div id="city-label" style="font-size: 0.9rem; font-weight: 700;">Jonkoping, Sweden</div>
    <div id="weather-info" style="font-size: 0.8rem; color: var(--accent); font-weight: 700;">Laddar...</div>
  </div>
</header>
<div id="main-wrapper">
  <div id="viewDiv"></div>
  <div id="sidebar">
    <section>
      <h3>Sok Plats</h3>
      <input type="text" id="customSearch" class="search-box" placeholder="Skriv stad (t.ex. Goteborg)...">
    </section>
    <section>
      <h3>Kameravy</h3>
      <button id="toggleMode" class="btn-main">Vaxla 2D/3D</button>
    </section>
    <section>
      <h3>Lager</h3>
      <p style="font-size: 0.8rem;">Byggnader och zoner laddas automatiskt.</p>
    </section>
  </div>
</div>
<script>
  // Vi vantar tills webblasaren ar helt redo
  window.onload = function() {
    require(["esri/Map","esri/views/SceneView","esri/layers/GeoJSONLayer","esri/layers/OSMBuildingsLayer","esri/widgets/Search"], 
    function(Map, SceneView, GeoJSONLayer, OSMBuildingsLayer, Search) {
      
      const zones = new GeoJSONLayer({
        url: "https://raw.githubusercontent.com/jacobm0810-collab/urban-viewer/main/Polygons_FeaturesToJSON.geojson",
        renderer: { type: "unique-value", field: "Name",
          uniqueValueInfos: [
            { value: "0 - 5", symbol: { type: "simple-fill", color: [74, 222, 128, 0.6] } },
            { value: "5 - 10", symbol: { type: "simple-fill", color: [250, 204, 21, 0.6] } },
            { value: "10 - 15", symbol: { type: "simple-fill", color: [248, 113, 113, 0.6] } }
          ]
        }
      });

      const map = new Map({ basemap: "hybrid", ground: "world-elevation", layers: [zones, new OSMBuildingsLayer()] });
      const view = new SceneView({ container: "viewDiv", map: map, camera: { position: [14.261, 57.781, 1500], tilt: 50 } });

      // Enkel sokfunktion som inte kraver tunga widgets
      const searchWidget = new Search({ view: view });
      document.getElementById("customSearch").addEventListener("keypress", (e) => {
        if (e.key === "Enter") { searchWidget.search(e.target.value); }
      });

      // Vaderfunktion
      async function updateWeather() {
        try {
          const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${view.center.latitude}&longitude=${view.center.longitude}&current_weather=true`);
          const data = await res.json();
          document.getElementById("weather-info").innerText = Math.round(data.current_weather.temperature) + "Â°C | Online";
        } catch (e) {}
      }

      view.when(() => { updateWeather(); });
      view.on("drag-end", updateWeather);

      let is3D = true;
      document.getElementById("toggleMode").onclick = () => { is3D = !is3D; view.goTo({ tilt: is3D ? 50 : 0 }); };
      
      zones.when(() => view.goTo(zones.fullExtent));
    });
  };
</script>
</body>
</html>
