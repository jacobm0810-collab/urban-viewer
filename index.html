<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <title>Urban Management | Digital Twin</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; font-family: sans-serif; background: #f1f5f9; overflow: hidden; }
    header { height: 60px; background: white; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; border-bottom: 2px solid #e2e8f0; z-index: 100; }
    .logo { font-weight: 800; text-transform: uppercase; }
    #main-wrapper { display: flex; height: calc(100% - 60px); width: 100%; }
    #viewDiv { flex: 1; height: 100%; background: #dee2e6; }
    #sidebar { width: 300px; background: white; border-left: 2px solid #e2e8f0; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
    .btn-main { width: 100%; padding: 12px; background: #0f172a; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    h3 { font-size: 0.75rem; text-transform: uppercase; color: #64748b; margin: 0; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
  </style>
</head>

<body>

<header>
  <div class="logo">Urban Management</div>
  <div id="status" style="text-align: right; font-size: 0.8rem;">
    <b id="city-label">Jonkoping, SE</b><br>
    <span id="weather-label" style="color: #0284c7">Ansluter till karta...</span>
  </div>
</header>

<div id="main-wrapper">
  <div id="viewDiv"></div>
  <div id="sidebar">
    <section>
      <h3>Kameravy</h3>
      <button id="viewBtn" class="btn-main">Vaxla till 2D</button>
    </section>
    <section>
      <h3>Lager</h3>
      <p style="font-size: 0.8rem; color: #64748b;">3D Byggnader och Isokroner laddas automatiskt.</p>
    </section>
  </div>
</div>

<script>
  window.addEventListener('load', function() {
    if (typeof require !== 'undefined') {
      require([
        "esri/Map",
        "esri/views/SceneView",
        "esri/layers/GeoJSONLayer",
        "esri/layers/OSMBuildingsLayer"
      ], function(Map, SceneView, GeoJSONLayer, OSMBuildingsLayer) {
        
        const zones = new GeoJSONLayer({
          url: "https://raw.githubusercontent.com/jacobm0810-collab/urban-viewer/main/Polygons_FeaturesToJSON.geojson",
          renderer: {
            type: "unique-value",
            field: "Name",
            uniqueValueInfos: [
              { value: "0 - 5", symbol: { type: "simple-fill", color: [74, 222, 128, 0.5] } },
              { value: "5 - 10", symbol: { type: "simple-fill", color: [250, 204, 21, 0.5] } },
              { value: "10 - 15", symbol: { type: "simple-fill", color: [248, 113, 113, 0.5] } }
            ]
          }
        });

        const map = new Map({ 
          basemap: "hybrid", 
          ground: "world-elevation", 
          layers: [zones, new OSMBuildingsLayer()] 
        });

        const view = new SceneView({
          container: "viewDiv",
          map: map,
          camera: { position: { longitude: 14.261, latitude: 57.781, z: 1500 }, tilt: 50 }
        });

        view.when(() => {
          document.getElementById("weather-label").innerText = "Kartan ar redo";
          
          fetch("https://api.open-meteo.com/v1/forecast?latitude=57.78&longitude=14.26&current_weather=true")
            .then(r => r.json())
            .then(d => {
              document.getElementById("weather-label").innerText = Math.round(d.current_weather.temperature) + " Celsius | Klart";
            });
        });

        let is3D = true;
        document.getElementById("viewBtn").onclick = function() {
          is3D = !is3D;
          view.goTo({ tilt: is3D ? 50 : 0 });
          this.innerText = is3D ? "Vaxla till 2D" : "Vaxla till 3D";
        };

      });
    }
  });
</script>
</body>
</html>
